import RadarConnection
import E8254A

%an option to use signal generator via ethernet. check the ip address of
%signal before usage
%{
sigen=E8254A('10.0.0.16',5025);
sigen.reset();
sigen.SetFreq(9282);
sigen.wait_complete();
sigen.SetAmp(-20);
sigen.wait_complete();
sigen.RF_On();
%}

%setup connection to radar and set technicial mode, and choose relevat
%number of receivers. To choose reciever set 'ON', to not choose set 'OF'
radar=RadarConnection('10.0.0.69',57);
radar.tech_mode_on();
radar.set_state_recievers('ON','ON','ON','ON');

%set vector according to protocol:
%11- number of command at hostcomm
%i - reciever number
%24 byte vector where: 
%2*4 - digital value for each channel
%3*4 - analog value for each channel
%1*4 - attenuator value for each channel
%digital values are constant for all modules, the only one that changes is
%analog and attenuator

%AGC maximum signal vector (vector 0):
%{
radar.set_vector('11,0,0x14,0x78,0x14,0x78,0x14,0x78,0x14,0x78,0x3E,0x3B,0x2F,0x28,0x45,0x52,0x26,0x42,0x37,0x38,0x4A,0x31,0x03,0x03,0x03,0x03');
radar.set_vector('11,1,0x14,0x78,0x14,0x78,0x14,0x78,0x14,0x78,0x36,0x34,0x30,0x1C,0x32,0x3F,0x30,0x41,0x24,0x41,0x30,0x33,0x03,0x03,0x03,0x03');
radar.set_vector('11,2,0x14,0x78,0x14,0x78,0x14,0x78,0x14,0x78,0x3A,0x3A,0x48,0x2E,0x33,0x40,0x31,0x36,0x3B,0x47,0x38,0x35,0x03,0x03,0x03,0x03');
radar.set_vector('11,3,0x14,0x78,0x14,0x78,0x14,0x78,0x14,0x78,0xF0,0x4D,0x33,0xF0,0x3B,0x58,0xF0,0x32,0x33,0xF0,0x33,0x2F,0x03,0x03,0x03,0x03');
%}

%AGC minimum signal vector (vector 79):

radar.set_vector('11,0,0x14,0x78,0x14,0x78,0x14,0x78,0x14,0x78,0xF0,0xF0,0x45,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0x57,0xF0,0x0F,0x0F,0x0F,0x0F');
%{
radar.set_vector('11,1,0x14,0x78,0x14,0x78,0x14,0x78,0x14,0x78,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0x0F,0x0F,0x0F,0x0F');
radar.set_vector('11,2,0x14,0x78,0x14,0x78,0x14,0x78,0x14,0x78,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0x0F,0x0F,0x0F,0x0F');
radar.set_vector('11,3,0x14,0x78,0x14,0x78,0x14,0x78,0x14,0x78,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0x0F,0x0F,0x0F,0x0F');
%}

%ACG vector 70:
%{
radar.set_vector('11,0,0x14,0x78,0x14,0x78,0x14,0x78,0x14,0x78,0xF0,0xF0,0x45,0xF0,0xF0,0xF0,0x63,0xF0,0xF0,0xF0,0x57,0xF0,0x0F,0x0F,0x0F,0x0F');
radar.set_vector('11,1,0x14,0x78,0x14,0x78,0x14,0x78,0x14,0x78,0xF0,0xF0,0x55,0x59,0x57,0xF0,0xF0,0xF0,0xF0,0xF0,0xDF,0x69,0x0F,0x0F,0x0F,0x0F');
radar.set_vector('11,2,0x14,0x78,0x14,0x78,0x14,0x78,0x14,0x78,0xF0,0xF0,0x67,0xF0,0x52,0xF0,0x57,0xF0,0xF0,0xF0,0xF0,0xF0,0x0F,0x0F,0x0F,0x0F');
radar.set_vector('11,3,0x14,0x78,0x14,0x78,0x14,0x78,0x14,0x78,0xF0,0xF0,0x5B,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0x61,0xF0,0x0F,0x0F,0x0F,0x0F');
%}


%AGC vector 60:
%{
radar.set_vector('11,0,0x14,0x78,0x14,0x78,0x14,0x78,0x14,0x78,0xF0,0xF0,0x45,0xF0,0x79,0xF0,0x3F,0xF0,0xF0,0xF0,0x57,0xF0,0x0F,0x0F,0x0F,0x0F');
radar.set_vector('11,1,0x14,0x78,0x14,0x78,0x14,0x78,0x14,0x78,0xF0,0x6D,0x45,0x2F,0x33,0xF0,0x4D,0xF0,0xF0,0xF0,0x5B,0x4B,0x0F,0x0F,0x0F,0x0F');
radar.set_vector('11,2,0x14,0x78,0x14,0x78,0x14,0x78,0x14,0x78,0xF0,0x6F,0x56,0x58,0x3C,0xF0,0x3B,0xF0,0xF0,0xF0,0xF0,0x65,0x0F,0x0F,0x0F,0x0F');
radar.set_vector('11,3,0x14,0x78,0x14,0x78,0x14,0x78,0x14,0x78,0xF0,0xF0,0x35,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0x3F,0x47,0x05,0x0F,0x0F,0x0F');
%}


%AGC Vector (index 40) of -72dBm:

%radar.set_vector('11,0,0x14,0x78,0x14,0x78,0x14,0x78,0x14,0x78,0x4E,0x46,0x3D,0x36,0x33,0xF0,0x37,0xF0,0x4F,0xF0,0x57,0x2C,0x0F,0x0F,0x0F,0x0F');
%radar.set_vector('11,1,0x14,0x78,0x14,0x78,0x14,0x78,0x14,0x78,0x44,0x31,0x35,0x34,0x2F,0xF0,0x30,0x54,0x33,0x7D,0x37,0x2E,0x0F,0x0F,0x0F,0x0F'); 
%radar.set_vector('11,2,0x14,0x78,0x14,0x78,0x14,0x78,0x14,0x78,0x3C,0x31,0x2F,0x40,0x3B,0xF0,0x2F,0xF0,0x22,0x34,0x41,0x2D,0x0F,0x0F,0x0F,0x0F'); 
%radar.set_vector('11,3,0x14,0x78,0x14,0x78,0x14,0x78,0x14,0x78,0xF0,0x55,0x33,0xF0,0x35,0xF0,0xF0,0x3C,0x45,0xF0,0x42,0x32,0x05,0x0F,0x0F,0x0F'); 




%AGC Vector by index - not exactly finished, should be updated at the hostcomm commands:
%11 - number of command
%AA - number of sub command
%0x28 - index number
%should add number of receiver
%radar.set_vector('11, 0xAA, 0x28');



%open log file
logFileName = 'recordFile_radar1.log';
logFile=fopen(logFileName,'w');
%starts ADC DMA path on XILINX and dump the data into logfile
radar.start_recording_and_get_results(logFile);


% after the loop is finished close ports for signal generator and radar
%sigen.close_port();
radar.close_port();
fclose(logFile);
fileInfo = dir(logFileName);
if fileInfo.bytes == 0
    fprintf('\x1b[31mThe log file is empty.\x1b[0m Aborting script.\n');
    return;  % Abort the script execution
end

clear all
close all
adc_filename =  ['D:\MATLAB_15_2_22\recordFile_radar1.log'];


channels = 1:4;
% use einan's algorithm to analyze the result
analyze_adc_log_usb(adc_filename, channels,0);
